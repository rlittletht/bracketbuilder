<html>
    <head>
        <script>

            const parseState =
            {
                LookingForGame: 0,
                LFG_AfterHyphen: 1,
                LFG_ParsingNumber: 2,
                LFG_ParsingNumber_WS: 3, // trailing whitespace after game number
                LookingForTopLeft: 4,
                LFTL_AfterOpen: 5,
                LFTL_FirstNum: 6,
                LFTL_AfterComma: 7,
                LFTL_SecondNum: 8,
                LFTL_AfterSecondNum: 9,
                LookingForBottomRight: 10,
                LFBR_AfterOpen: 11,
                LFBR_FirstNum: 12,
                LFBR_AfterComma: 13,
                LFBR_SecondNum: 14,
                LFBR_AfterSecondNum: 15,
            };

            const lexCharCat =
            {
                other: 0,
                hyphen: 1,
                digit: 2,
                openBracket: 3,
                closeBracket: 4,
                comma: 5,
                colon: 6,
                whitespace: 7,
            };

            function lexChar(ch)
            {
                if (ch == '-')
                    return lexCharCat.hyphen;
                else if (isDigitChar(ch))
                    return lexCharCat.digit;
                else if (ch == '[')
                    return lexCharCat.openBracket;
                else if (ch == ']')
                    return lexCharCat.closeBracket;
                else if (ch == ',')
                    return lexCharCat.comma;
                else if (ch == ' ' || ch == '\t' || ch == '\r' || ch == '\n')
                    return lexCharCat.whitespace;
                else if (ch == ':')
                    return lexCharCat.colon;

                return lexCharCat.other;
            }

            function isDigitChar(ch)
            {
                return ch >= '0' && ch <= '9';
            }

            const transitions =
            [
                [
                    null, // other
                    { psNext: parseState.LFG_AfterHyphen, term: false, production: prodCaptureStart }, // hypen
                    { psNext: parseState.LFG_ParsingNumber, term: false, production: prodCaptureStart }, // digit
                    null, // [
                    null, // ]
                    null, // ,
                    null, // :
                    null, // WS
                ], /*lookingForGame*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFG_ParsingNumber, term: false }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset } // WS
                ], /*LFG_AfterHyphen*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFG_ParsingNumber, term: false }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForTopLeft, term: false, production: prodCaptureEndNotInclusive, key: "gameNum" }, // :
                    { psNext: parseState.LFG_ParsingNumber_WS, term: false } // WS
                ], /*LFG_ParsingNumber*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset, unget: true }, // hypen
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset, unget: true }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForTopLeft, term: false, production: prodCaptureEndNotInclusive, key: "gameNum" }, // :
                    { psNext: parseState.LFG_ParsingNumber, term: false } // WS
                ], /*LFG_ParsingNumber_WS*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // digit
                    { psNext: parseState.LFTL_AfterOpen, term: false }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LookingForTopLeft, term: false } // WS
                ], /*LookingForTopLeft*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFTL_FirstNum, term: false, production: prodCaptureStart }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFTL_AfterOpen, term: false } // WS
                ], /*LFTL_AfterOpen*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFTL_FirstNum, term: false }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LFTL_AfterComma, term: false, production: prodCaptureEndNotInclusive, key: "TopLeftFirstNum" }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFTL_AfterOpen, term: false } // WS
                ], /*LFTL_FirstNum*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFTL_SecondNum, term: false, production: prodCaptureStart }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFTL_AfterComma, term: false } // WS
                ], /*LFTL_AfterComma*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFTL_SecondNum, term: false }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LFTL_AfterSecondNum, term: false, production: prodCaptureEndNotInclusive, key: "TopLeftSecondNum" }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFTL_SecondNum, term: false } // WS
                ], /*LFTL_SecondNum*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForBottomRight, term: false }, // hypen
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFTL_AfterSecondNum, term: false } // WS
                ], /*LFTL_AfterSecondNum*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // digit
                    { psNext: parseState.LFBR_AfterOpen, term: false }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LookingForBottomRight, term: false } // WS
                ], /*LookingForBottomRight*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFBR_FirstNum, term: false, production: prodCaptureStart }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFBR_AfterOpen, term: false } // WS
                ], /*LFBR_AfterOpen*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFBR_FirstNum, term: false }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LFBR_AfterComma, term: false, production: prodCaptureEndNotInclusive, key: "BottomRightFirstNum" }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFBR_AfterOpen, term: false } // WS
                ], /*LFBR_FirstNum*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFBR_SecondNum, term: false, production: prodCaptureStart }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFBR_AfterComma, term: false } // WS
                ], /*LFBR_AfterComma*/
                [
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // other
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // hypen
                    { psNext: parseState.LFBR_SecondNum, term: false }, // digit
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // [
                    { psNext: parseState.LookingForGame, term: true, production: prodCaptureEndNotInclusive, key: "BottomRightSecondNum" }, // ]
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // ,
                    { psNext: parseState.LookingForGame, term: false, production: prodTotalReset }, // :
                    { psNext: parseState.LFBR_SecondNum, term: false } // WS
                ], /*LFBR_SecondNum*/
            ];

            function prodTotalReset(source, ichCur, ichFirstMatch, ichLastMatch, tokenBuilding, key)
            {
                return [ichCur, -1, -1, { }];
            }

            function prodCaptureReset(source, ichCur, ichFirstMatch, ichLastMatch, tokenBuilding, key)
            {
                return [ichCur, -1, -1, tokenBuilding];
            }
            function prodCaptureStart(source, ichCur, ichFirstMatch, ichLastMatch, tokenBuilding, key)
            {
                return [ichCur, ichCur, -1, tokenBuilding];
            }

            function prodCaptureEndNotInclusive(source, ichCur, ichFirstMatch, ichLastMatch, tokenBuilding, key)
            {
                if (key)
                    tokenBuilding[key] = source.substring(ichFirstMatch, ichCur);

                return [ichCur, ichFirstMatch, ichCur - 1, tokenBuilding];
            }

            function lex(dump, ichCur, ps)
            {
                let ichFirstMatch = -1;
                let ichLastMatch = -1;
                let tokenBuilding = {};

                while (ichCur < dump.length)
                {
                    const lexCh = lexChar(dump[ichCur]);
                    const transition = transitions[ps][lexCh];

                    if (transition)
                    {
                        if (transition.production)
                        {
                            [ichCur, ichFirstMatch, ichLastMatch, tokenBuilding] = transition.production(dump, ichCur, ichFirstMatch, ichLastMatch, tokenBuilding, transition.key);
                        }

                        ps = transition.psNext;
                        if (transition.term)
                            return [ps, ichCur + 1, ichFirstMatch, ichLastMatch, tokenBuilding];

                        if (transition.unget)
                            ichCur--;
                    }

                    ichCur++;
                }

                return [ps, -1, -1, -1]; // we hit EOF
            }

            function parseDump(dump)
            {
                let items = [];
                let ichCur = 0;
                let ps = parseState.LookingForGame;
                let ichFirst = -1;
                let ichLast = -1;
                let token;

                while (ichCur >= 0 && ichCur < dump.length)
                {
                    [ps, ichCur, ichFirst, ichLast, token] = lex(dump, ichCur, ps);

                    if (token && token != null)
                    {
                        let item = 
                        {
                            gameNumber: parseInt(token.gameNum),
                            topLeft: [parseInt(token.TopLeftFirstNum), parseInt(token.TopLeftSecondNum)],
                            bottomRight: [parseInt(token.BottomRightFirstNum), parseInt(token.BottomRightSecondNum)]
                        }
                        items.push(item);
                    }
                }
                return items;
            }

            const dxSize = 20;
            const dySize = 5;

            function drawVertLine(ctx, col, maxRow)
            {
                ctx.beginPath();
                ctx.moveTo(col * dxSize, 0);
                ctx.lineTo(col * dxSize, (maxRow + 1) * dySize);
                ctx.strokeStyle = "#CCCCCC";
                ctx.stroke();
            }

            function drawHorizLine(ctx, row, maxCol)
            {
                ctx.beginPath();
                ctx.moveTo(0, row * dySize);
                ctx.lineTo((maxCol + 1) * dxSize, row * dySize);
                ctx.strokeStyle = "#CCCCCC";
                ctx.stroke();
            }

            function drawItem(ctx, item)
            {
                ctx.fillStyle = "#000000";
                ctx.fillRect(
                    item.topLeft[1] * dxSize,
                    item.topLeft[0] * dySize,
                    item.bottomRight[1] * dxSize - item.topLeft[1] * dxSize + dxSize,
                    item.bottomRight[0] * dySize - item.topLeft[0] * dySize + dySize);

                const text1 = "" + item.topLeft[0] + "," + item.topLeft[1];

                ctx.fillStyle = "#ffffff";
                if (item.gameNumber == -1)
                {
                    ctx.font = "6px Arial";
                    ctx.fillText(
                        text1,
                        item.topLeft[1] * dxSize + dxSize / 8,
                        item.topLeft[0] * dySize + dySize);
                }
                else
                {
                    ctx.font = "10px Arial";
                    ctx.fillText(
                        text1,
                        item.topLeft[1] * dxSize + dxSize / 8,
                        item.topLeft[0] * dySize + dySize * 1.5);

                }

                if (item.gameNumber != -1)
                {
                    const text2 = "" + item.bottomRight[0] + "," + item.bottomRight[1];
                    ctx.fillText(
                        text2,
                        item.bottomRight[1] * dxSize - dxSize / 4,
                        item.bottomRight[0] * dySize);

                    ctx.fillText(
                        "" + item.gameNumber,
                        (item.topLeft[1] + (item.bottomRight[1] - item.topLeft[1]) / 2) * dxSize + dxSize / 4,
                        (item.topLeft[0] + (item.bottomRight[0] - item.topLeft[0]) / 2) * dySize + dySize);
                }
            }
            function visualize()
            {
                let dump = document.getElementById("textGridData").value;
                let items = parseDump(dump);
                    // "1: [9,6]-[19,8]  Grid.ts:1342 2: [23,6]-[33,8]  Grid.ts:1342 -1: [28,9]-[28,11]");

                if (items.length == 0)
                    return;

                let minRow = items[0].topLeft[0];
                let maxRow = items[0].bottomRight[0];
                let minCol = items[0].topLeft[1];
                let maxCol = items[0].bottomRight[1];

                // figure out the extents of the grid
                for (const iItem in items)
                {
                    const item = items[iItem];

                    minRow = Math.min(minRow, item.topLeft[0]);
                    maxRow = Math.max(maxRow, item.bottomRight[0]);
                    minCol = Math.min(minCol, item.topLeft[1]);
                    maxCol = Math.max(maxCol, item.bottomRight[1]);
                }

                // draw a grid on the canvas
                let x = 0;
                let y = 0;

                let can = document.getElementById("canViz");
                var ctx = can.getContext("2d");

                ctx.clearRect(0, 0, (maxCol + 1) * dxSize, (maxRow + 1) * dySize);

                // draw the vertical lines
                while (x <= maxCol)
                {
                    drawVertLine(ctx, x, maxRow);
                    x++;
                }
                while (y <= maxRow)
                {
                    drawHorizLine(ctx, y, maxCol);
                    y++;
                }

                // and now draw each item
                for (const iItem in items)
                {
                    const item = items[iItem];

                    drawItem(ctx, item);
                }
            }

        </script>
    </head>
    <body>
        <p>Debugging visualizations for bbld</p>
        <canvas style="float: right" id="canViz" width="1200" height="800">

        </canvas>
        <textarea style="float:left" id="textGridData" rows="20" cols="80">
            1: [9,6]-[19,8]
Grid.ts:1342 2: [23,6]-[33,8]
Grid.ts:1342 -1: [28,9]-[28,11]
Grid.ts:1342 3: [37,6]-[47,8]
Grid.ts:1342 -1: [42,9]-[42,11]
Grid.ts:1342 4: [51,6]-[61,8]
Grid.ts:1342 5: [13,9]-[23,11]
Grid.ts:1342 6: [63,9]-[73,11]
Grid.ts:1342 7: [77,9]-[87,11]
Grid.ts:1342 8: [67,12]-[77,14]
Grid.ts:1342 9: [27,12]-[43,14]
        </textarea>
        <button onclick="visualize()">Visualize!</button>
        </p>
    </body>
</html>